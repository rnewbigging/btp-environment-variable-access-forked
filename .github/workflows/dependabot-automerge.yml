name: dependabot merger

on:
  pull_request:
    branches: [ main ]

jobs:
#  wait-for-workflows:
#    runs-on: ubuntu-latest
#    #if: ${{ github.actor == 'dependabot[bot]' && github.event_name == 'pull_request' }}
#    steps:
#      - name: wait for workflows
#        run: |
#          workflow_runs=$(curl -s \
#          -H "Authorization: Bearer ${{secrets.GITHUB_TOKEN}}" \
#          "https://api.github.com/repos/${{github.repository}}/pulls/${{ github.event.pull_request.number }}/check-runs")
#
#          # Debug Check
#          echo "$workflow_runs"
#
#          # Check if in progress
#          in_progress=$(echo "workflow_runs" | jq -r 'map(select(.status == "in_progress")) | length')
#
#          # Debug Check
#          echo "$in_progress"
#
#          # Wait for completion -> TODO Replace loop with better solution
#          while [ "$in_progress" -gt 0 ]; do
#            sleep 30
#            in_progress=$(echo "workflow_runs" | jq -r 'map(select(.status == "in_progress")) | length')
#          done
#  checks:
#    runs-on: ubuntu-latest
#    needs: wait-for-workflows
#    #if: ${{ github.actor == 'dependabot[bot]' && github.event_name == 'pull_request' }}
#    steps:
#      - name: check ci build
#        id: check_ci
#        run: |
#          check_run=$(curl -s \
#          -H "Authorization: Bearer ${{secrets.GITHUB_TOKEN}}" \
#          "https://api.github.com/repos/${{github.repository}}/commits/${{github.event.pull_request.head.sha}}/check-runs?check_name=Java%20CI%20with%20Maven")
#
#          # check
#          echo "$check_run"
#
#          # Get raw conclusion from check run, first result
#          check_status=$(echo "$check_run" | jq -r '.check_runs[0].conclusion')
#
#          # check
#          echo "$check_status"
#
#          # Set output of step to status
#          echo "check_ci=check_status" >> $GITHUB_OUTPUT
##
##      - name: check codeql scan
##        id: check_codeql
##        run: |
##          # GET check run for ci-build
##          check_run=$(curl -s \
##          -H "Authorization: Bearer ${{secrets.GITHUB_TOKEN}}" \
##          "https://api.github.com/repos/${{github.repository}}/commits/${{github.event.pull_request.head.sha}}/check-runs?check_name=CodeQL%20Scan") \
##
##          # Get raw conclusion from check run
##          check_status=$(echo "$check_run" | jq -r '.check_runs[0].conclusion')
##
##          # Set output of step to status
##          echo"::set-output name=check_codeql::$check_status"

  review-pr:
    runs-on: ubuntu-latest
    #needs: checks
    if: ${{ github.actor == 'dependabot[bot]' && 
            github.event_name == 'pull_request' }}
#      &&
#            needs.checks.outputs.check_ci == 'success' }}
#      &&
#      needs.checks.outputs.check_codeql == 'success'}}
    permissions:
      pull-requests: write
      contents: write
    steps:
      - name: dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v1.3.1
        with:
          github-token: '${{ secrets.GITHUB_TOKEN }}'
      - name: approve
        run: gh pr review --approve "$PR_URL"
        env:
          PR_URL: ${{github.event.pull_request.html_url}}
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
      - name: enable auto-merge for dependabot PRs
        # Condition: Only patches, TODO
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{github.event.pull_request.html_url}}
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
